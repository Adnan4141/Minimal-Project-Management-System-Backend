
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum UserRole {
  Admin
  Manager
  Member
}

enum ProjectStatus {
  planned
  active
  completed
  archived
}

enum TaskStatus {
  ToDo
  InProgress
  Review
  Done
}

enum TaskPriority {
  Low
  Medium
  High
  Critical
}

enum ActivityType {
  created
  updated
  status_changed
  assigned
  commented
  attachment_added
  time_logged
  completed
}


model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  name              String
  role              UserRole  @default(Member)
  department        String?
  skills            String[]
  avatar            String?
  isActive          Boolean   @default(true)
  inviteToken       String?
  inviteTokenExpiry DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  assignedTasks    TaskAssignment[]
  createdProjects  Project[]         @relation("ProjectCreator")
  managedProjects  Project[]         @relation("ProjectManager")
  createdTasks     Task[]            @relation("TaskCreator")
  createdSprints   Sprint[]
  comments         Comment[]
  timeLogs         TimeLog[]
  activities       ActivityLog[]
  attachments      Attachment[]

  @@index([email])
  @@index([role])
  @@map("users")
}


model Project {
  id          String        @id @default(uuid())
  title       String
  client      String
  description String?       @db.Text
  startDate   DateTime
  endDate     DateTime
  budget      Decimal?      @db.Decimal(12, 2)
  status      ProjectStatus @default(planned)
  thumbnail   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  creatorId   String
  creator     User          @relation("ProjectCreator", fields: [creatorId], references: [id])
  managerId   String?
  manager     User?         @relation("ProjectManager", fields: [managerId], references: [id])
  sprints     Sprint[]

  @@index([status])
  @@index([client])
  @@index([creatorId])
  @@map("projects")
}


model Sprint {
  id          String   @id @default(uuid())
  title       String
  sprintNumber Int
  startDate   DateTime
  endDate     DateTime
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id])
  tasks       Task[]

  @@unique([projectId, sprintNumber])
  @@index([projectId])
  @@map("sprints")
}


model Task {
  id          String       @id @default(uuid())
  title       String
  description String?      @db.Text
  estimate    Decimal?     @db.Decimal(8, 2)
  priority    TaskPriority @default(Medium)
  status      TaskStatus   @default(ToDo)
  dueDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  sprintId    String
  sprint      Sprint       @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  creatorId   String
  creator     User         @relation("TaskCreator", fields: [creatorId], references: [id])
  parentTaskId String?
  parentTask  Task?        @relation("TaskSubtasks", fields: [parentTaskId], references: [id])
  subtasks    Task[]       @relation("TaskSubtasks")
  assignees   TaskAssignment[]
  comments    Comment[]
  attachments Attachment[]
  timeLogs    TimeLog[]
  activities  ActivityLog[]

  @@index([sprintId])
  @@index([status])
  @@index([priority])
  @@index([parentTaskId])
  @@map("tasks")
}

model TaskAssignment {
  id        String   @id @default(uuid())
  assignedAt DateTime @default(now())

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_assignments")
}

model Comment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    Comment? @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentThread")

  @@index([taskId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model Attachment {
  id          String   @id @default(uuid())
  filename    String
  fileUrl     String
  fileType    String
  fileSize    Int
  uploadedAt  DateTime @default(now())

  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedById String?
  uploadedBy  User?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@map("attachments")
}

model TimeLog {
  id          String   @id @default(uuid())
  hours       Decimal  @db.Decimal(8, 2)
  description String?  @db.Text
  loggedAt    DateTime @default(now())
  date        DateTime

  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([date])
  @@map("time_logs")
}

model ActivityLog {
  id          String       @id @default(uuid())
  type        ActivityType
  description String?      @db.Text
  metadata    Json?
  createdAt   DateTime     @default(now())

  taskId      String?
  task        Task?        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String?

  @@index([taskId])
  @@index([userId])
  @@index([projectId])
  @@index([type])
  @@index([createdAt])
  @@map("activity_logs")
}
